<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorting Algorithms Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card { margin-bottom: 20px; }
        .result-table { font-size: 0.9em; }
        .fast { color: green; font-weight: bold; }
        .slow { color: red; font-weight: bold; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .upload-area.dragover { border-color: #0d6efd; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üîç Perbandingan Algoritma Sorting</h1>
        
        <!-- Upload Data Section -->
        <div class="card">
            <div class="card-header">
                <h5>üìÅ Upload Data CSV</h5>
            </div>
            <div class="card-body">
                <div class="upload-area" id="uploadArea">
                    <p>Drag & drop file CSV di sini atau klik untuk memilih</p>
                    <input type="file" id="fileInput" accept=".csv" class="d-none">
                    <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                        Pilih File
                    </button>
                </div>
                <div id="uploadInfo" class="mt-2"></div>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="card">
            <div class="card-header">
                <h5>‚ö° Test Sorting Algorithms</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Test Single Size</h6>
                        <div class="input-group mb-3">
                            <select class="form-select" id="dataSize">
                                <option value="1000">1,000 Data</option>
                                <option value="5000">5,000 Data</option>
                                <option value="10000">10,000 Data</option>
                                <option value="50000">50,000 Data</option>
                            </select>
                            <button class="btn btn-primary" onclick="runSingleTest()">Run Test</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Test Multiple Sizes</h6>
                        <button class="btn btn-warning" onclick="runMultipleTests()">
                            Test 1K, 10K, 50K
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card">
            <div class="card-header">
                <h5>üìä Hasil Perbandingan</h5>
            </div>
            <div class="card-body">
                <div id="resultsSection">
                    <p class="text-muted">Hasil test akan muncul di sini...</p>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card">
            <div class="card-header">
                <h5>üìà Performance Chart</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script>
        let uploadedData = [];
        let currentResults = [];
        let performanceChart = null;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('uploadInfo').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    uploadedData = data.data;
                    document.getElementById('uploadInfo').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong> ${data.message}<br>
                            Sample data: [${data.sample_data.join(', ')}]
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('uploadInfo').innerHTML = 
                    `<div class="alert alert-danger">Error: ${error}</div>`;
            });
        }

        function runSingleTest() {
            const dataSize = document.getElementById('dataSize').value;
            const useUploaded = uploadedData.length > 0;

            const testData = {
                data_size: parseInt(dataSize),
                use_uploaded_data: useUploaded,
                uploaded_data: useUploaded ? uploadedData : []
            };

            fetch('/run_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
                currentResults = data.results;
                updateChart([data]);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function runMultipleTests() {
            fetch('/run_multiple_tests', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                displayMultipleResults(data);
                updateChart(data.multiple_results);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function displayResults(data) {
            let html = `
                <h6>Test Results - ${data.data_size.toLocaleString()} Data</h6>
                <small class="text-muted">Tested at: ${data.test_timestamp}</small>
                <table class="table table-striped result-table mt-3">
                    <thead>
                        <tr>
                            <th>Algorithm</th>
                            <th>Time (ms)</th>
                            <th>Data Size</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.results.forEach(result => {
                const timeClass = typeof result.time_ms === 'number' ? 
                    (result.time_ms < 100 ? 'fast' : 'slow') : '';
                const timeDisplay = typeof result.time_ms === 'number' ? 
                    result.time_ms.toLocaleString() : result.time_ms;
                
                html += `
                    <tr>
                        <td>${result.algorithm}</td>
                        <td class="${timeClass}">${timeDisplay}</td>
                        <td>${result.data_size.toLocaleString()}</td>
                        <td>${result.is_correct ? '‚úÖ Correct' : '‚ùå Error'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            document.getElementById('resultsSection').innerHTML = html;
        }

        function displayMultipleResults(data) {
            let html = `<h6>Multiple Test Results</h6>`;
            html += `<small class="text-muted">Tested at: ${data.test_timestamp}</small>`;

            data.multiple_results.forEach(sizeResult => {
                html += `
                    <div class="mt-4">
                        <h6>${sizeResult.data_size.toLocaleString()} Data</h6>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Algorithm</th>
                                    <th>Time (ms)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                sizeResult.results.forEach(result => {
                    const timeClass = typeof result.time_ms === 'number' ? 
                        (result.time_ms < 100 ? 'fast' : 'slow') : '';
                    const timeDisplay = typeof result.time_ms === 'number' ? 
                        result.time_ms.toLocaleString() : result.time_ms;
                    
                    html += `
                        <tr>
                            <td>${result.algorithm}</td>
                            <td class="${timeClass}">${timeDisplay}</td>
                            <td>${result.is_correct ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            });

            document.getElementById('resultsSection').innerHTML = html;
        }

        function updateChart(data) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            const datasets = [];
            const labels = Array.isArray(data) ? 
                data.map(item => item.data_size?.toLocaleString() || 'Test') : 
                [data.data_size.toLocaleString()];

            // Extract algorithms and their times
            const algorithms = {};
            if (Array.isArray(data)) {
                data.forEach(sizeResult => {
                    sizeResult.results?.forEach(result => {
                        if (!algorithms[result.algorithm]) {
                            algorithms[result.algorithm] = [];
                        }
                        algorithms[result.algorithm].push(
                            typeof result.time_ms === 'number' ? result.time_ms : 0
                        );
                    });
                });
            } else {
                data.results.forEach(result => {
                    if (!algorithms[result.algorithm]) {
                        algorithms[result.algorithm] = [];
                    }
                    algorithms[result.algorithm].push(
                        typeof result.time_ms === 'number' ? result.time_ms : 0
                    );
                });
            }

            const colors = {
                'Quick Sort': 'rgba(75, 192, 192, 0.8)',
                'Merge Sort': 'rgba(54, 162, 235, 0.8)',
                'Bubble Sort': 'rgba(255, 99, 132, 0.8)',
                'Selection Sort': 'rgba(255, 159, 64, 0.8)'
            };

            Object.keys(algorithms).forEach(algorithm => {
                datasets.push({
                    label: algorithm,
                    data: algorithms[algorithm],
                    backgroundColor: colors[algorithm] || 'rgba(153, 102, 255, 0.8)',
                    borderColor: colors[algorithm] || 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                });
            });

            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (milliseconds)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data Size'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>